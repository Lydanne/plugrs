#!/usr/bin/env bash

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

info "运行提交前检查..."

# 自动格式化代码
info "格式化代码..."
cargo fmt
git add -u  # 添加所有被格式化的文件到暂存区

# 运行 clippy
info "运行 Clippy 检查..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    error "Clippy 检查失败"
fi

# 运行测试
info "运行测试..."
if ! cargo test --all-features; then
    error "测试失败"
fi

# 检查提交信息格式
commit_msg=$(cat "$1" 2>/dev/null || git log -1 --pretty=%B)
if ! echo "$commit_msg" | git-cliff --strip all --verbose; then
    error "提交信息不符合 conventional commits 规范"
    echo "提交信息格式应该是：type(scope): description"
    echo "例如："
    echo "  feat: 添加新功能"
    echo "  fix: 修复 bug"
    echo "  docs: 更新文档"
    exit 1
fi

info "所有检查通过！"
exit 0 